<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allenatore Alimentare</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <h1>Allenatore Alimentare</h1>
    </header>

    <main>
        <p id="welcome-message">{{ message }}</p>
        
        <div class="content-wrapper">
           <!-- SEZIONE RICERCA ALIMENTO ESISTENTE - TEMPORANEAMENTE NASCOSTA
            <section id="search-section">
                <h2>Cerca un Alimento</h2>
                <div class="search-controls">
                    <label for="search-query">Nome prodotto:</label>
                    <input type="text" id="search-query" name="search-query" placeholder="Es. pasta, biscotti, ...">
                    <button id="search-button">Cerca</button>
                </div>
                <div id="results-area">
                    <p>I risultati della ricerca appariranno qui...</p>
                </div>
            </section>

            <!-- SEZIONE PER DATI UTENTE E CALCOLO FABBISOGNO -->
            <section id="fabbisogno-section"> 
                <h2>Calcola il Tuo Fabbisogno</h2>
                <form id="user-data-form">
                    <div>
                        <label for="age">Età (anni):</label>
                        <input type="number" id="age" name="age" required min="1" max="120">
                    </div>
                    <div>
                        <label for="weight">Peso (kg):</label>
                        <input type="number" id="weight" name="weight" step="0.1" required min="1">
                    </div>
                    <div>
                        <label for="height">Altezza (cm):</label>
                        <input type="number" id="height" name="height" required min="1">
                    </div>
                    <div>
                        <label for="gender">Sesso Biologico:</label>
                        <select id="gender" name="gender" required>
                            <option value="">Seleziona...</option>
                            <option value="male">Maschio</option>
                            <option value="female">Femmina</option>
                        </select>
                    </div>
                    <div>
                        <label for="activity-level">Livello di Attività Fisica:</label>
                        <select id="activity-level" name="activity_level" required>
                            <option value="">Seleziona...</option>
                            <option value="sedentary">Sedentario (poco o nessun esercizio)</option>
                            <option value="light">Leggermente attivo (esercizio leggero/sport 1-3 giorni/sett.)</option>
                            <option value="moderate">Moderatamente attivo (esercizio moderato/sport 3-5 giorni/sett.)</option>
                            <option value="active">Molto attivo (esercizio intenso/sport 6-7 giorni/sett.)</option>
                            <option value="extra_active">Estremamente attivo (esercizio molto intenso/lavoro fisico)</option>
                        </select>
                    </div>
                    <div>
                        <label for="profession">Professione (opzionale, per dettaglio attività):</label>
                        <input type="text" id="profession" name="profession" placeholder="Es. impiegato, muratore, studente">
                    </div>
                    <div>
                        <label for="objectives">Obiettivi (es. perdere peso, mantenimento, massa):</label>
                        <textarea id="objectives" name="objectives" rows="2" required placeholder="Descrivi i tuoi obiettivi..."></textarea>
                    </div>

                    <!-- NUOVI CAMPI ESSENZIALI, OGNUNO NEL SUO DIV -->
                    <div> 
                        <label for="medical-conditions">Malattie/Condizioni Mediche Rilevanti:</label>
                        <textarea id="medical-conditions" name="medical_conditions" rows="2" placeholder="Es. diabete, ipertensione... (opzionale)"></textarea>
                    </div>
                    <div>
                        <label for="allergies">Allergie Alimentari Note:</label>
                        <textarea id="allergies" name="allergies" rows="2" placeholder="Es. arachidi, nichel... (opzionale)"></textarea>
                    </div>
                    <div>
                        <label for="intolerances">Intolleranze Alimentari Note:</label>
                        <textarea id="intolerances" name="intolerances" rows="2" placeholder="Es. lattosio, glutine (non celiachia)... (opzionale)"></textarea>
                    </div>
                    
                    <div>
                        <button type="submit" id="calculate-needs-button">Calcola Fabbisogno</button>
                    </div>
                </form>
                <div id="needs-results-area"> <!-- Area per i risultati del fabbisogno -->
                    <p>Il tuo fabbisogno calorico e nutrizionale consigliato apparirà qui...</p>
                </div>
            </section>
        </div> 
    </main>

    <footer>
        <p>© 2024 Il Tuo Allenatore Alimentare</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- JAVASCRIPT PER LA RICERCA PRODOTTI (ESISTENTE) ---
            const searchButton = document.getElementById('search-button');
            const searchQueryInput = document.getElementById('search-query');
            const resultsArea = document.getElementById('results-area');

            if (searchButton) { 
                searchButton.addEventListener('click', function() {
                    const query = searchQueryInput.value.trim(); 
                    if (query === "") {
                        resultsArea.innerHTML = '<p style="color: red;">Per favore, inserisci un termine di ricerca.</p>';
                        return; 
                    }
                    resultsArea.innerHTML = '<p>Ricerca in corso...</p>';
                    fetch(`/api/search_food?query=${encodeURIComponent(query)}`)
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(errData => {
                                    throw new Error(errData.error || `Errore dal server: ${response.status}`);
                                });
                            }
                            return response.json(); 
                        })
                        .then(data => {
                            displaySearchResults(data); 
                        })
                        .catch(error => {
                            console.error('Errore durante la ricerca dei prodotti:', error);
                            resultsArea.innerHTML = `<p style="color: red;">Si è verificato un errore durante la ricerca: ${error.message}</p>`;
                        });
                });
            }

            function displaySearchResults(products) {
                if (!products || products.length === 0) {
                    resultsArea.innerHTML = '<p>Nessun prodotto trovato per la tua ricerca.</p>';
                    return;
                }
                let htmlContent = '<ul>';
                products.forEach(product => {
                    htmlContent += `<li>`;
                    if (product.image_url) {
                        htmlContent += `<img src="${product.image_url}" alt="${product.name || 'Immagine prodotto'}" style="width: 50px; height: 50px; margin-right: 10px; vertical-align: middle;">`;
                    }
                    htmlContent += `<strong>${product.name || 'Nome non disponibile'}</strong>`;
                    if (product.brands) {
                        htmlContent += ` - <em>${product.brands}</em>`;
                    }
                    htmlContent += `<br>`;
                    htmlContent += `<small>`;
                    if (product.calories_100g !== null && product.calories_100g !== undefined) {
                        htmlContent += `Calorie (100g): ${product.calories_100g} kcal | `;
                    }
                    if (product.protein_100g !== null && product.protein_100g !== undefined) {
                         htmlContent += `Proteine: ${product.protein_100g}g | `;
                    }
                    if (product.carbs_100g !== null && product.carbs_100g !== undefined) {
                        htmlContent += `Carboidrati: ${product.carbs_100g}g | `;
                    }
                    if (product.fat_100g !== null && product.fat_100g !== undefined) {
                        htmlContent += `Grassi: ${product.fat_100g}g`;
                    }
                    if (htmlContent.endsWith(' | ')) {
                       htmlContent = htmlContent.slice(0, -3);
                    }
                    htmlContent += `</small>`;
                    htmlContent += `</li>`;
                });
                htmlContent += '</ul>';
                resultsArea.innerHTML = htmlContent;
            }

            if (searchQueryInput) { 
                searchQueryInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault(); 
                        if (searchButton) searchButton.click(); 
                    }
                });
            }

            // --- JAVASCRIPT PER IL FORM DATI UTENTE ---
            const userDataForm = document.getElementById('user-data-form');
            const needsResultsArea = document.getElementById('needs-results-area');

            if (userDataForm) {
                userDataForm.addEventListener('submit', function(event) {
                    event.preventDefault(); 
                    const formData = new FormData(userDataForm);
                    const data = Object.fromEntries(formData.entries()); 
                    needsResultsArea.innerHTML = '<p>Analisi dei tuoi dati in corso con Gemini...</p>';
                    console.log("Dati utente inviati:", data); 
                    fetch('/api/calculate_needs', { 
                        method: 'POST', 
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data), 
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(errData => {
                                // Gestione dell'errore specifico da Gemini che hai mostrato
                                if (errData.message && errData.message.includes("API Key not valid")) {
                                     throw new Error("Servizio Gemini non disponibile (configurazione SDK fallita o API Key mancante).");
                                }
                                throw new Error(errData.error || `Errore dal server: ${response.status} - ${errData.message || 'Nessun dettaglio'}`);
                            });
                        }
                        return response.json();
                    })
                    .then(result => {
                        console.log("Risultato da /api/calculate_needs:", result);
                        let resultHTML = `<h3>Consigli Nutrizionali:</h3>`;
                        if (result.error) { // Errore gestito proveniente dal nostro backend o da gemini_service
                            resultHTML += `<p style="color: red;">${result.error}</p>`;
                        } else if (result.calories !== undefined) { // Successo e dati presenti
                            resultHTML += `
                                <p><strong>Fabbisogno Calorico Stimato:</strong> ${result.calories || 'Non disponibile'} kcal</p>
                                <p><strong>Proteine:</strong> ${result.protein || 'Non disponibile'} g</p>
                                <p><strong>Carboidrati:</strong> ${result.carbs || 'Non disponibile'} g</p>
                                <p><strong>Grassi:</strong> ${result.fat || 'Non disponibile'} g</p>
                                <p><em>${result.notes || ''}</em></p>
                            `;
                        } else { // Risposta inattesa
                             resultHTML += `<p style="color: orange;">Risposta ricevuta dal servizio non interpretabile.</p>`;
                        }
                        needsResultsArea.innerHTML = resultHTML;
                    })
                    .catch(error => {
                        console.error('Errore durante il calcolo del fabbisogno:', error);
                        needsResultsArea.innerHTML = `<p style="color: red;">Si è verificato un errore durante il calcolo: ${error.message}</p>`;
                    });
                });
            }

            // JavaScript per il campo "Altro" del tipo di dieta (se lo aggiungerai)
            const dietTypeSelect = document.getElementById('diet-type');
            const dietTypeOtherContainer = document.getElementById('diet-type-other-container');
            const dietTypeOtherInput = document.getElementById('diet-type-other');

            if (dietTypeSelect && dietTypeOtherContainer) {
                dietTypeSelect.addEventListener('change', function() {
                    if (this.value === 'other') {
                        dietTypeOtherContainer.style.display = 'block';
                        if(dietTypeOtherInput) dietTypeOtherInput.required = true; 
                    } else {
                        dietTypeOtherContainer.style.display = 'none';
                        if(dietTypeOtherInput) {
                            dietTypeOtherInput.required = false;
                            dietTypeOtherInput.value = ''; 
                        }
                    }
                });
                // Nascondi all'inizio se non è 'other'
                if (dietTypeSelect.value !== 'other') {
                     dietTypeOtherContainer.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>